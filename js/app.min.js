function app_init(){if(getQueryVariable("id"))tracker_id=getQueryVariable("id"),console.log("tracker_id: "+tracker_id),$.get("ajax/poll_tracker.php",{session_key:tracker_id},function(a){var b=jQuery.parseJSON(a);$("#tracker_name").text(b.username);var c=new google.maps.LatLng(b.lat,b.lng);mapOptions={zoom:16,center:c},map=new google.maps.Map(document.getElementById("map-canvas"),mapOptions),tracking_marker=new google.maps.Marker({position:c,title:b.username,icon:"http://project107.net/geo-ninja/img/marker.png"}),tracking_marker.setMap(map),tracker_int=setInterval(function(){pollTracker(tracker_id)},poll_interval),$("#identity-frm").hide(),$("#share-frm").hide(),$("#sts").html("Waiting for more data...").slideDown()});else{console.log("tracker = false");var a={enableHighAccuracy:!0,timeout:5e3,maximumAge:1e4};navigator.geolocation.getCurrentPosition(showCurrentUserPosition,errorHandler,a)}}function showCurrentUserPosition(a){my_lat=a.coords.latitude,my_lng=a.coords.longitude,my_acc=a.coords.accuracy,my_latlng=new google.maps.LatLng(my_lat,my_lng),mapOptions={zoom:16,center:my_latlng},map=new google.maps.Map(document.getElementById("map-canvas"),mapOptions),my_marker=new google.maps.Marker({position:my_latlng,title:"My location (approx)"}),my_marker.setMap(map)}function pollTracker(a){var b=Math.floor(999999999999999*Math.random()),c='<div class="beacon-icon"></div>';$.get("ajax/poll_tracker.php?"+b,{session_key:a},function(a){console.log(a);var b=jQuery.parseJSON(a);moveMarker(tracking_marker,!0,b.lat,b.lng);var d=b.accuracy;sts_msg=d>=1e3?"Accuracy  is awful. ("+d+"m)":"Accuracy ~"+d+"m",sts_msg+=". <em>Last update @ "+b.timestamp+"</em>"+c,$("#sts").html(sts_msg).show(),$(".beacon-icon").show().fadeOut()})}function shareLocation(){var a=$("#recip").val();console.log(a),$("#share-frm").slideUp(),$("#sts").addClass("success").html("Invite sent!").slideDown(200).delay(2e3).slideUp(200),$.post("ajax/share_location.php",{lat:my_lat,lng:my_lng,user:username,recip:a,acc:my_acc},function(a){obj=jQuery.parseJSON(a),getLocationUpdate()})}function getLocationUpdate(){if(navigator.geolocation){var a={timeout:6e4,maximumAge:5e3};geoLoc=navigator.geolocation,watchID=geoLoc.watchPosition(sendLocation,errorHandler,a)}else alert("Sorry, browser does not support geolocation!")}function sendLocation(a){var b=a.coords.latitude,c=a.coords.longitude,d=a.coords.accuracy;sts_msg=d>=1e3?"Position sent ok. Accuracy is awful. ("+d+"m)":"Position sent ok. Accuracy ~"+d+"m",$.post("ajax/post_coords.php",{lat:b,lng:c,session_key:obj.session_key,user:username,accuracy:d},function(){$("#sts").removeClass("success").html(sts_msg).slideDown(200).delay(5e3).slideUp(100),moveMarker(my_marker,!0,b,c)})}function getQueryVariable(a){for(var b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(e[0]==a)return e[1]}return!1}function setName(){$("#identity-frm").slideUp(200),$("#share-frm").slideDown(200),username=$("#username").val(),$("#tracker_name").html(username+" (you)")}function moveMarker(a,b,c,d){a.setPosition(new google.maps.LatLng(c,d)),b&&map.panTo(new google.maps.LatLng(c,d)),console.log("moved to: lat = "+c+" / lng = "+d)}function errorHandler(a){1==a.code?alert("Error: Access is denied!"):2==a.code&&alert("Error: Position is unavailable!")}var watchID,geoLoc,map,mapOptions,tracking_marker,sts_msg,my_marker,my_latlng,my_lat,my_lng,my_acc,username,tracker_lat="",tracker_lng="",tracker_user="",tracker_id,tracker_int,poll_interval=5e3;